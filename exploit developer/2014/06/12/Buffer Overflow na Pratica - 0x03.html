<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Buffer Overflow na Pratica - 0x03</title>
	
	<meta name="author" content="mh4x0f">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/mh4x0f">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/mh4x0f">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:mh4root@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="http://avatars.githubusercontent.com/u/6795613" class="img-circle" />
				
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="http://avatars.githubusercontent.com/u/6795613" class="img-circle" style="width:112px;height:112px;" />
	</a>
	<h3 class="title">
        <a href="/"></a>
    </h3>
</header>


<div id="bio" class="text-center">
	One 0x41414141 worth a thousand words
</div>

<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/mh4x0f">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/mh4x0f">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:mh4root@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<form class="col-lg-12" action="http://feedburner.google.com/fb/a/mailverify?uri=chmodsecurity" method="post" target="popupwindow" onsubmit="window.open('http://feedburner.google.com/fb/a/mailverify?uri=chmodsecurity', 'popupwindow', 'scrollbars=yes,width=250,height=220');return true" >
			<div class="input-group" style="width:240px;text-align:center;margin:0 auto;">
			<input type="hidden" value="chmodsecurity" name="uri" >
		  <input type="hidden" name="loc" value="pt_BR">
		  <input  id="input-rss"  style="width:160px;text-align:center;" placeholder="Digite  seu e-mail" class="form-control input-lg" type="text" name="email">
		  <span class="input-group-btn"><button id="btn-assinar" class="btn btn-lg btn-primary"  type="submit" value=" ASSINAR ">Assinar</button></span>
	      </div>
		</form>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Buffer Overflow na Pratica - 0x03 </h1>
</div>
	
<article>
	<div class="col-sm-10">
	 <span class="post-date">
	   
	   June 
	   12th,
	   
	   2014
	 </span>
	  <div class="article_body">
	  <p>Se você chegou aqui, então é recomendado que veja o início dessa saga sobre buffer overflow. Vamos desenvolver um programa vulnerável para que possamos entender na prática como tudo funciona, vamos usar C, como base, até porque em outros artigos vamos precisar do mesmo para desenvolver outras coisas avançadas, nesse artigo não se preocupe vai ser moleza.</p>
<p>Vamos lá, primeiro vamos criar um arquivo.c com seguinte código.</p>
<pre class="brush: c; gutter: false;">
#include&lt; stdio.h &gt;
#include&lt; stdlib.h &gt;
void main (){
  char *nome;
  char *comando;
  nome = (char *)malloc(10);
  comando = (char *)malloc(40);
  printf("endereço da variavel Nome:%d\n",nome);
  printf("endereço da variavel comando:%d\n",comando);
  printf("Digite seu nome:");
  gets(nome);
  printf("Bem vindo: %s\n",nome);
  system(comando);  
}
</pre>
<p><br /></p>
<p>vamos para explicação, é muitos simples declaramos duas variáveis como ponteiro, em seguida alocamos as mesmas na memoria usando a função <a>malloc</a>, Por que precisamos usa-la ? quando declaramos uma variável como  ponteiro, não definimos o tamanho que ela vai ocupar na memória, deixar ele sem declarar o tamanho 
é muito usado apenas quando queremos executar um shellcode até porque não sabemos o tamanho do mesmo,definimos a variável <a>nome</a> com 10 bytes, e na variável <a>comando</a> definimos como 40 bytes.
</p>
<p>A vulnerabilidade ocorre na função <a>gets</a>, que é vulnerável quando não definimos o tamanho que vamos copiar para o ponteiro uma forma de acabar com isso é usando a irmã dela <a>fgets (char *str, int len, FILE *pt</a> e usamos sizeof para calcular o tamanho da string a ser copiada para memória. </p>
<p>Vamos compilar nosso código com gcc, e testar.</p>
<pre class="code">
&#9484;&#9472;[mh4]&#9472;[mh4x05]&#9472;[~/lab/buffer]-#
&#9492;&#9472;&#9472;&gt;&gt;nano buffer.c 
&#9484;&#9472;[mh4]&#9472;[mh4x05]&#9472;[~/lab/buffer]-#
&#9492;&#9472;&#9472;&gt;&gt;ls
buffer.c
&#9484;&#9472;[mh4]&#9472;[mh4x05]&#9472;[~/lab/buffer]-#
&#9492;&#9472;&#9472;&gt;&gt;gcc -o programa buffer.c 
&#9484;&#9472;[mh4]&#9472;[mh4x05]&#9472;[~/lab/buffer]-#
&#9492;&#9472;&#9472;&gt;&gt;./programa 
endereço da variavel Nome:33402896
endereço da variavel comando:33402928
Digite seu nome:Chmod Security
Bem vindo: Chmod Security
</pre>
<p>&lt;/br&gt;</p>
<p>Veja que não aconteceu nada apenas, o programa comportou-se como deveria né voltando a string que 
digitamos <a>Chmod Security</a>, isso quer dizer que ainda não passamos de 10 bytes, com nossa string Chmod Security, vamos digitarmos uma frase agora 'Chmod Security teste de bufferoverflow'.<p>
<pre class="code">
&#9484;&#9472;[mh4]&#9472;[mh4x05]&#9472;[~/lab/buffer]-#
&#9492;&#9472;&#9472;&gt;&gt;./programa 
endereço da variavel Nome:25542672
endereço da variavel comando:25542704
Digite seu nome:Chmod Security teste de bufferoverflow 
Bem vindo: Chmod Security teste de bufferoverflow 
sh: 1: erflow: Permission denied
&#9484;&#9472;[mh4]&#9472;[mh4x05]&#9472;[~/lab/buffer]-#
&#9492;&#9472;&#9472;&gt;&gt;
</pre><br />
<p>Olha só <a>"sh: 1: erflow: Permission denied"</a>, Isso quer dizer que o limite da variável vai
até 'Chmod Security teste de bufferov',  logo depois que ele passa de 10 bytes, ele começa a ocupar espaço da outra variável <a>comando</a>, então o que aconteceria se no lugar da string 'erflow'
nós colocarmos o comando 'ls -ln', que lista os arquivos vamos lá.</p>
<pre class="code">
&#9484;&#9472;[mh4]&#9472;[mh4x05]&#9472;[~/lab/buffer]-#
&#9492;&#9472;&#9472;&gt;&gt;./programa 
endereço da variavel Nome:35991568
endereço da variavel comando:35991600
Digite seu nome:Chmod Security teste de bufferovls -ln
Bem vindo: Chmod Security teste de bufferovls -ln
total 12
-rw-rw-r-- 1 1000 1000  350 Jun 10 06:12 buffer.c
-rwxrwxr-x 1 1000 1000 7356 Jun 10 06:12 programa
&#9484;&#9472;[mh4]&#9472;[mh4x05]&#9472;[~/lab/buffer]-#
&#9492;&#9472;&#9472;&gt;&gt;
</pre>
<p>HAHAAHA, ele simplesmente executou nosso comando 'ls -ln ',com a função system(comando), esse é um exemplo simples de como funciona um simples buffer overflow,  fazeendo mais um teste, cat /etc/passwd, colocando com nossa string fica assim  'Chmod Security teste de bufferovcat /etc/passwd'.</p>
<pre class="code">
&#9484;&#9472;[mh4]&#9472;[mh4x05]&#9472;[~/lab/buffer]-#
&#9492;&#9472;&#9472;&gt;&gt;./programa 
endereço da variavel Nome:35991568
endereço da variavel comando:35991600
Digite seu nome:Chmod Security teste de bufferovls -ln
Bem vindo: Chmod Security teste de bufferovls -ln
total 12
-rw-rw-r-- 1 1000 1000  350 Jun 10 06:12 buffer.c
-rwxrwxr-x 1 1000 1000 7356 Jun 10 06:12 programa
&#9484;&#9472;[mh4]&#9472;[mh4x05]&#9472;[~/lab/buffer]-#
&#9492;&#9472;&#9472;&gt;&gt;./programa 
endereço da variavel Nome:37568528
endereço da variavel comando:37568560
Digite seu nome:Chmod Security teste de bufferovcat /etc/passwd
Bem vindo: Chmod Security teste de bufferovcat /etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/bin/sh
bin:x:2:2:bin:/bin:/bin/sh
sys:x:3:3:sys:/dev:/bin/sh
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/bin/sh
man:x:6:12:man:/var/cache/man:/bin/sh
lp:x:7:7:lp:/var/spool/lpd:/bin/sh
mail:x:8:8:mail:/var/mail:/bin/sh
news:x:9:9:news:/var/spool/news:/bin/sh
uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh
proxy:x:13:13:proxy:/bin:/bin/sh
www-data:x:33:33:www-data:/var/www:/bin/sh
backup:x:34:34:backup:/var/backups:/bin/sh
list:x:38:38:Mailing List Manager:/var/list:/bin/sh
irc:x:39:39:ircd:/var/run/ircd:/bin/sh
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/sh
nobody:x:65534:65534:nobody:/nonexistent:/bin/sh
libuuid:x:100:101::/var/lib/libuuid:/bin/sh
syslog:x:101:103::/home/syslog:/bin/false
messagebus:x:102:105::/var/run/dbus:/bin/false
colord:x:103:108:colord colour management daemon,,,:/var/lib/colord:/bin/false
lightdm:x:104:111:Light Display Manager:/var/lib/lightdm:/bin/false
usbmux:x:105:46:usbmux daemon,,,:/home/usbmux:/bin/false
ntp:x:106:114::/home/ntp:/bin/false
whoopsie:x:107:115::/nonexistent:/bin/false
avahi-autoipd:x:108:117:Avahi autoip daemon,,,:/var/lib/avahi-autoipd:/bin/false
avahi:x:109:118:Avahi mDNS daemon,,,:/var/run/avahi-daemon:/bin/false
pulse:x:110:119:PulseAudio daemon,,,:/var/run/pulse:/bin/false
rtkit:x:111:121:RealtimeKit,,,:/proc:/bin/false
speech-dispatcher:x:112:29:Speech Dispatcher,,,:/var/run/speech-dispatcher:/bin/sh
hplip:x:113:7:HPLIP system user,,,:/var/run/hplip:/bin/false
saned:x:114:122::/home/saned:/bin/false
mh4:x:1000:1000:mh4x05,,,:/home/mh4:/bin/bash
postgres:x:1001:1002::/home/postgres:/bin/sh
sshd:x:115:65534::/var/run/sshd:/usr/sbin/nologin
debian-xfs:x:116:125::/nonexistent:/bin/false
&#9484;&#9472;[mh4]&#9472;[mh4x05]&#9472;[~/lab/buffer]-#
&#9492;&#9472;&#9472;&gt;&gt;
</pre>
<p>Yeap,isso deu certo conseguimos listar o conteúdo do arquivo <a>passwd</a>, lembrando sempre que 
precisar copiar algum para memoria defina o tamanho da string, outra coisa existem proteções com esse tipo 
violação, claro né, ASLR para desabilitar  'echo 0 &gt; /proc/sys/kernel/randomize_va_space'usando u user root.</p><br />
<p> NX bit - Non eXecute bit :que impede a execução de código em áreas que temos permissão de escrita, pode desabilita-lo com -z execstack
 e compilar com ggc usando essa freg</p><br />
<p> Smash The Stack Protection também conhecido como ProPolice, também é usado o gcc com a freg  -fno-stack-protector. </p>
<p>Em fim, até o windows tem proteção contra violão de momória eles o chama DEP. que futuramente irei fazer um papers falando como fazer bypass nela.
 agora é só comparar o conhecimento que viram na teoria antes desse artigo e deduzir qual tipo de exploração foi demostrada stack ou heap ?. continuei ligado nos artigos que vamos aprender futuramente como desenvolver um shellcode Ops : Os famosos Opcodes. dar uma lida na pagina shellcode e entenda como funciona que vai ser a base para nosso aprendizado :D ,OK até a próxima.
</p></p></p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#exploit developer-ref">
					exploit developer <span>(5)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#Buffer-ref">
					Buffer <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#overflow-ref">
					overflow <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#como funciona-ref">
					como funciona <span>(1)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Buffer Overflow na Pratica - 0x03&via=mh4x0f"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="http://avatars.githubusercontent.com/u/6795613" style="width:80px;height:80px;" class="img-rounded author-image" />
        <h4 class="section-title author-name">mh4x0f</h4>
        <p class="author-bio">One 0x41414141 worth a thousand words</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/exploit%20developer/2014/06/11/Entendendo%20Buffer%20Overflow%20-%200x02.html" title="Entendendo Buffer Overflow - 0x02">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/exploration/2014/06/15/Task%20Manager%20com%20planilhas%20Excel%20%5BMACRO%5D.html" title="Task Manager com planilhas Excel [MACRO]">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>



    
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'mh4x0fblog';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>





		<footer>
			<hr/>
			<p>
				&copy; 2015 mh4x0f with Jekyll. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'mh4x0f']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

